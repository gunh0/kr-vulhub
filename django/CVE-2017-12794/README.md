# django/CVE-2017-12794

## contributor
[정다은(@xmi1e-vir)](https://github.com/xmi1e-vir)

## ABOUT CVE
### CVE번호
- CVE-2017-12794
### 취약점
- Django의 디버그 페이지에서의 **XSS (크로스 사이트 스크립팅) 취약점**
### 세부내용
- Django는 Postgres 데이터베이스에서 오류가 발생할 때 **디버그 페이지**를 표시
  - 데이터베이스에서 두 번 발생하는 **중복 오류** (예: 두 번 같은 사용자명으로 계정 생성) 때문에 발생한 예외의 원인이 디버그 페이지에 출력될 때 이 취약점이 트리거
  - psycopg2가 필드 이름과 값 모두를 출력

- Django 버전 1.10.x 이전의 1.10.8 및 1.11.x 이전의 1.11.5에서, 기술적인 500 디버그 페이지의 템플릿의 일부분에서 **HTML 자동 이스케이핑이 비활성화**
  
- 이로 인해 **(XSS)크로스 사이트 스크립팅** 공격이 허용

- 대부분의 실제 운영 환경에서는 **"DEBUG = True"** 설정을 사용하지 않기 때문에 이러한 취약점에 영향을 받지 않을 것

### 취약점 패치
- Django 1.11.4에서 이 취약점이 존재하며, 1.11.5에서 이 문제가 수정
- Django를 1.11.5 이상 버전으로 업그레이드 하면 오류 메시지에 안전한 처리가 추가되어 있어 취약점을 악용할 수 없음

## CVE 실습 환경 구축
### docker
#### docker 설치
- `apt install -y docker.io`
- 설치 확인<br>
  `docker info`
#### docker-compose 설치
- `sudo curl -L "https://github.com/docker/compose/releases/download/1.28.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose`
- 설치확인<br>
  `docker-compose --version`
#### sudo 명령어의 지속적 사용을 피하기 위해 다음 명령어로 docker그룹에 현재 유저 추가
  `sudo usermod -aG docker ${USER}`
  - 도커 재시작<br>
    `sudo service docker restart`<br><br>
#### vulhub 레포지토리 복제
  `git clone https://github.com/phith0n/vulhub.git`<br>
  `cd vulhub/django/CVE-2017-12794`<br><br>
#### docker 빌드
  `docker-compose build`<br><br>
#### docker 컨테이너 실행
  `docker-compose up -d`<br><br>
#### docker 컨테이너로 전환
  `docker exec -it [Docker ID] /bin/bash`<br><br>
  - 확인을 위해 넣은 과정이므로 필수는 아님.<br><br>
![컨테이너 실행 화면](docker_run.png)

## POC(Proof of Concept) 코드
```PHP
http://localhost:8000/create_user/?username=<script>alert(1)</script>
```
1. 웹 애플리케이션의 사용자 등록 페이지에 들어가서 사용자 이름(username) 필드에 악의적인 스크립트 코드를 입력
2. 같은 스크립트 코드를 가진 또 다른 사용자를 등록하려고 시도
3. 중복 키 예외(duplicate key exception)가 발생 후 예외 메시지는 사용자 입력 값과 함께 웹 페이지에 표시
4. 예외 메시지에 악의적인 스크립트 코드가 삽입되어 표시되므로, 사용자가 해당 페이지를 방문할 때 스크립트가 실행되는 XSS 취약점이 발생

## 실습
### docker 컨테이너를 실행시켜 Django 서비스와 Postgres 서비스 시작
`docker compose up`
### Django 서비스 시작
- docker-compose.yml 에 자동으로 8000 포트에 실행되도록 설정되어 있음
### 웹 브라우저에 POC 코드 삽입
#### firefox 와 같은 웹 브라우저에 다음 POC 코드 삽입
  ```php
  http://localhost:8000/create_user/?username=<script>alert(1)</script>
  ```
  
  ![첫번째 실행화면](first_execute.png)
  - 처음 삽입시 **정상적으로 사용자 생성**<br>
#### 다시 한번 POC 코드 삽입
<br>

  ![두번째 실행화면](second_execute_XSS.png)
  - **중복 키 예외**가 발생하여 **XSS가 실행**
  - "1"이라는 알림 창이 표시

## 레퍼런스
### CVE 관련 분석 자료
- [https://wiki.96.mk/Web安全/Django/（CVE-2017-12794）Django debug page XSS漏洞/](https://wiki.96.mk/Web%E5%AE%89%E5%85%A8/Django/%EF%BC%88CVE-2017-12794%EF%BC%89Django%20debug%20page%20XSS%E6%BC%8F%E6%B4%9E/)
- https://www.opencve.io/cve/CVE-2017-12794
- https://nvd.nist.gov/vuln/detail/CVE-2017-12794
- https://security.snyk.io/vuln/SNYK-PYTHON-DJANGO-40626
### 환경 구축 관련 자료
- https://velog.io/@jeong3320/dockerdocker-sudo%EA%B6%8C%ED%95%9C%EC%97%86%EC%9D%B4-%EC%8B%A4%ED%96%89%ED%95%98%EA%B8%B0
- https://velog.io/@agzg/docker%EB%8F%84%EC%BB%A4-%EB%AA%85%EB%A0%B9%EC%96%B4-%EB%AA%A8%EC%9D%8C
- https://zhfvkq.tistory.com/41
