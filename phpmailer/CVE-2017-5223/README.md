# PHPMailer 임의 파일 읽기 취약점(CVE-2017-5223)

이메일을 보낼 때 PHPMailer는 이메일 내용에서 이미지 태그(`<img src="...">`)를 찾아 src 속성 값을 첨부 파일로 추출합니다. 따라서 이메일 내용의 일부를 제어할 수 있다면 `<img src="/etc/passwd">`를 사용하여 `/etc/passwd` 파일을 첨부 파일로 읽을 수 있어 임의 파일 읽기 취약점이 발생할 수 있습니다.

  - http://www.freebuf.com/vuls/124820.html
  - https://www.exploit-db.com/exploits/43056/

## 취약점 재현 환경

다음 내용으로 현재 디렉터리에 '.env' 파일을 만듭니다.(이 파일의 구성 값을 아래 예시를 참고하여 SMTP 서버, 계정 및 비밀번호로 변경합니다)

````
SMTP_SERVER=smtp.example.com
SMTP_PORT=587
SMTP_EMAIL=your_email@example.com
SMTP_PASSWORD=password
SMTP_SECURE=tls
````

그 중 `SMTP_SECURE`는 SMTP 암호화 방식으로 none, ssl, tls를 입력할 수 있습니다.

.env 파일을 만든 다음 테스트 환경을 컴파일하고 실행합니다.

````
docker compose build
docker compose up -d
````

환경이 시작된 후 `http://your-ip:8080/`을 방문하면 "피드백" 페이지가 표시됩니다.

## 취약점 재현

"피드백" 페이지에서는 사용자가 자신의 닉네임, 이메일 주소를 입력하고 의견을 제출합니다. 이 정보는 백엔드에 저장되며, 동시에 백엔드는 사용자에게 의견 작성을 요청하는 이메일을 보냅니다.

![](1.png)

> 이 장면은 실제 흔히 볼 수 있는 장면으로, 예를 들어 사용자가 사이트에 등록한 후 자신의 닉네임이 포함된 알림 메일이 오면 닉네임에 악성코드 `<img src="/etc/passwd">`를 삽입하면 대상 서버에 있는 파일이 첨부 파일로 읽힙니다.

마찬가지로 "댓글" 위치에 악성 코드를 채웁니다.

![](2.png)

`/etc/passwd` 및 `/etc/hosts` 첨부 파일이 포함된 이메일을 수신된 것을 확인할 수 있습니다.

![](3.png)

