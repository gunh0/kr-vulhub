# Django 500 Debug Page Cross-Site Scripting (XSS)

화이트햇 스쿨 3기 김민규

Django는 빠른 개발과 깔끔하고 실용적인 디자인을 장려하는 고수준 Python 웹 프레임워크입니다.

Django 1.11.5 및 1.10.8 이전 버전에서 Debug Error Page에 오류 메시지에 사용자의 입력을 escape 처리하지 않아 XSS(Cross-Site Scripting)이 발생합니다.

## 1. 취약한 환경 구성

취약한 환경을 구성하기 위해 vulhub에서 git clone으로 환경을 받아와 줍니다.

### 1) git clone vulhub.git

```bash
git clone https://github.com/vulhub/vulhub.git
```

`/vulhub` 디렉터리 안에는 다양한 종류의 취약한 환경 목록을 확인할 수 있습니다.

![vulhub 목록 예시](https://github.com/minnggyuu/kr-vulhub/blob/main/Django/CVE-2017-12794/img/image1.png)

### 2) docker-compose up -d
![docker-compose 파일](https://github.com/minnggyuu/kr-vulhub/blob/main/Django/CVE-2017-12794/img/image2.png)
docker-compose.yml 파일을 사용하면 빌드, 실행, 연결을 하나의 파일로 동시에 처리할 수 있습니다.

```bash
docker-compose up -d
```

![docker-compose 실행 예시](https://github.com/minnggyuu/kr-vulhub/blob/main/Django/CVE-2017-12794/img/image3.png)

## 2. 환경 접속 & 익스플로잇

![환경 접속 예시](https://github.com/minnggyuu/kr-vulhub/blob/main/Django/CVE-2017-12794/img/image4.png)

구축한 환경은 `/create_user` 엔드포인트에서 `username`이라는 파라미터를 받습니다.

1을 인자로 보내보니, user가 만들어졌다는 메시지를 반환합니다.

![user 생성 성공](https://github.com/minnggyuu/kr-vulhub/blob/main/Django/CVE-2017-12794/img/image5.png)

같은 요청을 반복하니 `Key(username) = (1)` 이 이미 존재한다는 이유로 500 에러를 반환한 모습을 확인했습니다.

같은 방식으로 `1` 대신 `<script>` 구문을 삽입해 보겠습니다.

![스크립트 삽입 시도](https://github.com/minnggyuu/kr-vulhub/blob/main/Django/CVE-2017-12794/img/image6.png)

![스크립트 실행 확인](https://github.com/minnggyuu/kr-vulhub/blob/main/Django/CVE-2017-12794/img/image7.png)

개발자 도구의 HTML Elements를 확인해 보면, 에러 상세 메시지에 `<script>` 구문이 삽입되면서 스크립트가 실행된 것을 볼 수 있습니다.

## 📍 공격 시나리오

### 서버에서 XSS가 가능한 환경

- Stored XSS 공격 가능
- 웹 사이트 내 게시글이나 댓글에 스크립트 삽입
- 사용자의 쿠키 탈취 가능

### 서버에서 XSS가 불가능한 환경

- Reflected XSS 공격 가능
- 사용자에게 공격 페이로드가 포함된 URL을 전송
- 클릭을 유도하여 쿠키 탈취 가능

## 3. 패치

![패치 설명 이미지](https://github.com/minnggyuu/kr-vulhub/blob/main/Django/CVE-2017-12794/img/image8.png)

취약점 발견 이후, Django에서 에러 메시지를 이스케이프 처리한 뒤 출력하도록 변경하여 패치했습니다.

