# Apache Airflow Celery Broker Remote Command Execution (CVE-2020-11981)
Apache Airflow는 오픈소스, 분산 작업 프레임워크입니다.
1.10.10 이전 버전에서는, Redis brocker(ex:Redis 또는 RabbitMQ) 공격자에 의해 조작되어지는 경우 공격자가 사용자의 프로세스에서 임의로 명령어를 실행할 수 있습니다.

시작해야할 구성요소가 많기 때문에 약간 막힐 수 있습니다.
메모리 2G 이상의 Virtual machine을 준비해 주세요.

참고자료:
-  <https://lists.apache.org/thread/cn57zwylxsnzjyjztwqxpmly0x9q5ljx>
-  <https://github.com/apache/airflow/pull/9178>

## 취약점 환경

다음 명령어를 실행하여 airflow 1.10.10 서버를 실행합니다:

```bash
#Initialize the database
docker compose run airflow-init

#Start service
docker compose up -d
```

## 취약점 공격(Exploit)

이 취약점을 공격하려면 Celery brocker인 Redis의 쓰기 권한을 얻어야 합니다.
Vulhub 환경에서는 Redis의 포트 6379가 인터넷에 노출됩니다.

Redis으로 해킹하기 위해 코드를 큐(queue)에 추가하여 명령어를 실행합니다.
`airflow.executors.celery_executor.execute_command`

이 스크립트로 [exploit_airflow_celery.py](exploit_airflow_celery.py)의 명령어를 실행합니다. `touch /tmp/airflow_celery_success`

```
pip install redis
python exploit_airflow_celery.py [your-ip]
```

로그에서 결과를 볼 수 있습니다. 
```bash
docker compose logs airflow-worker
```

![](1.png)


보다시피 성공적으로 실행되었습니다.
```
docker compose exec airflow-worker ls -l /tmp
```
![](2.png)
