# CVE-2022-0778

**Contributors**

-   [오원영(@RoughBoy0723)](https://github.com/RoughBoy0723)

<br/>

### 요약

-   OpenSSL은 외부로의 위협으로부터 컴퓨터네트워크를 통한 통신을 보호하거나 상대방을 식별해야하는 응용 소프트웨어 라이브러리입니다.

-   OpenSSL에서 공격자가 조작된 인증서를 통해 무한 루프를 발생시켜 서비스 거부를 유도할 수 있는 취약점이 발견되었습니다.

-   이 취약점은 인증서 파싱시 사용되는 BN_mod_sqrt 함수로 인해 발생하였습니다.

```
\* crypto/bn/bn_sqrt.c L310-L318 *\
    while (!BN_is_one(t)) {
        i++;
        if (i == e) {
            ERR_raise(ERR_LIB_BN, BN_R_NOT_A_SQUARE);
            goto end;
        }
    if (!BN_mod_mul(t, t, t, p, ctx))
        goto end;
    }
```

-   알고리즘에 따르면 고정된 e와 증가하는 i에 대해 해당 loop는 `i == e`인 시점에 끝나야 합니다.

-   하지만 특수한 입력값을 주어 `i=1, e=1` 인 상태로 해당 loop에 진입하도록 유도한다면 무한 loop가 발생하여 서비스 거부가 발생하게 됩니다.

<br/>

### 레퍼런스 링:

-   <https://github.com/drago-96/CVE-2022-0778>

-   <https://www.cnblogs.com/logchen/p/16030515.html>

-   <https://catbro666.github.io/posts/83951100/>

-   <https://github.com/yywing/cve-2022-0778>

-   <https://hackyboiz.github.io/2022/03/19/syru/cve-2022-0778>

<br/>

### 환경 구성 및 실행

1. 현재 디렉토리의 yml 파일을 실행합니다.
-     `docker compose up -d`
      
2. wing/cve-2022-0778이미지를 사용하여 취약한 서버를 생성합니다.
-     `docker run -it --rm -p 12345:12345 yywing/cve-2022-0778 --addr 0.0.0.0:12345` 

3. 만들은 서버 내부의 CPU사용량을 top 명령어를 통해 모니터링합니다.
-     `docker compose exec curl top` 

4. 환경에 진입하고 cURL을 사용하여 이전에 시작한 악성 서버를 접속합니다
-     `docker compose exec curl bash` 
-     `curl -k https://host.docker.internal:12345`

<br/>

### 결과
![cpu_0%to100%](https://github.com/RoughBoy0723/whitehat-school-vulhub/assets/106831435/2950d933-ef91-4cd6-bc68-7abca6945850)
접속을 시작하자 서버 컴퓨터의 CPU사용량이 100%가되어 과부하가 되는것을 확인할 수 있습니다.

<br/>


### 정리

-   해당 취약점은 `i == e` 를 종료 조건으로 가지는 for문으로 바꾸는 방법으로 패치되었습니다.

```
/* Find the smallest i, 0 < i < e, such that b^(2^i) = 1. */
for (i = 1; i < e; i++) {
    if (i == 1) {
        if (!BN_mod_sqr(t, b, p, ctx))
            goto end;

    } else {
        if (!BN_mod_mul(t, t, t, p, ctx))
            goto end;
    }
    if (BN_is_one(t))
        break;
}
/* If not found, a is not a square or p is not prime. */
if (i >= e) {
    ERR_raise(ERR_LIB_BN, BN_R_NOT_A_SQUARE);
    goto end;
}
```
