FROM ubuntu:20.04

RUN apt-get update --allow-releaseinfo-change && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    wget curl make gcc g++ perl libpcre3 libpcre3-dev \
    libapr1 libapr1-dev libexpat1-dev && \
    apt-get clean

RUN wget https://archive.apache.org/dist/apr/apr-1.7.0.tar.gz && \
    tar xvfz apr-1.7.0.tar.gz && cd apr-1.7.0 && \
    ./configure --prefix=/usr/local/apr && make && make install

RUN wget https://archive.apache.org/dist/apr/apr-util-1.6.1.tar.gz && \
    tar xvfz apr-util-1.6.1.tar.gz && cd apr-util-1.6.1 && \
    ./configure --with-apr=/usr/local/apr --prefix=/usr/local/apr-util && \
    make && make install

RUN wget https://sourceforge.net/projects/pcre/files/pcre/8.45/pcre-8.45.tar.gz && \
    tar xvfz pcre-8.45.tar.gz && cd pcre-8.45 && \
    ./configure --prefix=/usr/local/pcre && make && make install

RUN wget https://archive.apache.org/dist/httpd/httpd-2.4.49.tar.gz && \
    tar -xf httpd-2.4.49.tar.gz && cd httpd-2.4.49 && \
    ./configure --prefix=/usr/local/apache2.4.49 \
    --enable-module=so --enable-rewrite --enable-so \
    --with-apr=/usr/local/apr/ \
    --with-apr-util=/usr/local/apr-util \
    --with-pcre=/usr/local/pcre \
    --enable-mods-shared=all && \
    make && make install

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 8080
CMD ["/entrypoint.sh"]
