# Apache Superset Python Pickle Deserialization Leads to RCE [CVE-2023-37941]

> [화이트햇 스쿨 3기 5반 이한필]
> https://github.com/zz8086/kr-vulhub/tree/main/superset/CVE-2023-37941
> 

## CVE-2023-37941
Apache Superset 1.5부터 2.1.0 버전까지는 Python Pickle 역직렬화 취약점(CVE-2023-37941)을 포함하고 있습니다. 이 애플리케이션은 메타데이터 데이터베이스에 일부 설정 데이터를 저장하기 위해 Python의 pickle 패키지를 사용을 합니다.  
메타데이터 데이터베이스에 쓰기 권한이 있는 인증된 사용자가 악의 적인 pickle 페이로드를 삽입을 할 수 있으며, 애플리케이션이 이를 역직렬화할 때 superset 서버에서 원격 코드 실행(RCE)이 발생할 수 있습니다.  
또한, CVE-2023-27524와 결합될 경우, 인증되지 않은 공격자가 먼저 인증 우회에 성공한 뒤, 역직렬화 취약점을 악용하여 원격 코드 실행(RCE)을 달성할 수 있습니다.

## Apache Superset & pickle
**Apache Superset :** 페타바이트 규모의 데이터를 처리할 수 있는 데이터 탐색 및 데이터 시각화를 위한 오픈 소스 소프트웨어 어플리케이션입니다.  

**pickle :** 텍스트 상태의 데이터가 아닌 파이썬 객체 자체를 바이너리 파일로 저장하는 것을 의미합니다.

## 환경 구성
Apache Superset 2.0.1 서버를 시작하려면 다음 명령어를 실행을 합니다.
```bash
docker compose up -d
```
서버가 실행이 되면, Superset에 접속을 할 수 있습니다. http://localhost:8088  
로그인 정보는 다음과 같습니다. admin/vulhub

## 취약점 재현
웹 브라우저를 실행을 하고, localhost:8088에 접속을 합니다.  
개발자 도구를 실행을 하고, **"Storage"** -> value 값을 나중에 써야하므로, 메모장 같은 곳에 붙여넣습니다. (지금은 사용을 하지 않으나, 나중에 사용을 합니다.)

![Image](https://github.com/user-attachments/assets/bc81e52a-9aea-450c-b043-20f5161b3e43)

로그인을 한 후, **"DASHBOARD"** 을 클릭합니다.
![Image](https://github.com/user-attachments/assets/3b3eea81-db8c-44ba-895f-4daccad53d6e)

DASHBOARD 이름은 기본값으로 해도 무난합니다. **"SAVE"** 를 클릭합니다.
![Image](https://github.com/user-attachments/assets/874f5dc1-6e6d-422e-95d7-71e6175ed036)

**"Dashboards"** -> 방금 만들었던, Dashboard를 클릭합니다.
![Image](https://github.com/user-attachments/assets/b9596b38-f2e6-4832-a2d1-09d695e2af35)

**"Share"** -> **"Copy permalink to clipboard"** 를 클릭합니다. 이 링크 또한 메모장 같은데에 붙여넣습니다.
![Image](https://github.com/user-attachments/assets/9515ceb1-4472-4c4b-bd5c-40e692ba2b53)

**"Data"** -> **"Databbases"** -> **"+DATABASE"** 를 클릭합니다.
![Image](https://github.com/user-attachments/assets/a963a4cf-b978-4cde-ad4f-bf1cbb0350e9)

**"SQLite"** 를 클릭합니다.  
![Image](https://github.com/user-attachments/assets/7141f628-fb1f-4932-bad4-b8e77ef528ce)

SQLACHEMY URI 부분에 **"sqlite+pysqlite:////app/superset_home/superset.db"** 를 입력하고, **"ADVANCED"** 를 클릭합니다.
![Image](https://github.com/user-attachments/assets/561cea20-5a50-4532-8042-1da6e4be43e0)

ADVANCED 에서, 아래의 사진과 같이 체크를 하고, **"CONNECT"** 를 클릭합니다.
![Image](https://github.com/user-attachments/assets/f2deb931-dcfc-41ca-baa8-1b7f38b5df0c)

터미널로 돌아가 아래의 명령어들을 실행합니다.

```bash
sudo docker compose exec web ls /tmp/
```
위에 명령어를 실행하면 tmpsewok9rt만 있을 것입니다.
**!주의 역 직렬화 pickle payload는 운영 체제마다 다르므로 POC를 Linux 환경 또는 MacOS에서 진행을 해야합니다.**

```bash
python3 CVE-2023-37941.py -c "touch /tmp/success" -d sqlite
```
아래의 사진에서 표시되어 있는 부분을 복사합니다.
![Image](https://github.com/user-attachments/assets/f5ed7499-9122-4770-9add-7203615fafa4)

다시 웹사이트로 돌아가서, **"SQL Lab"** -> **"SQL Editor"** 를 클릭합니다.  
![Image](https://github.com/user-attachments/assets/c450fcdc-2ab8-4ae1-a53b-74e938a9efe2)

먼저, SCHEMA "main" , SEET TABLE SCHEMA "key_value" 로 설정을 합니다. 그리고,  
방금 복사를 해두었던, sql 구문을 붙여넣습니다. RUN을 클릭하여 실행을 하고, 
dashboard_permalink가 생겼는지 확인을 합니다.
![Image](https://github.com/user-attachments/assets/28d6fb3f-6fb5-4f1c-8e8b-b1d99ab680a7)

```bash
sudo curl -H "Cookie: session=(맨 처음 세션 값)" (두번째 클립보드 주소)
```
![Image](https://github.com/user-attachments/assets/071ef5af-6c24-447a-8dbc-369524042abc)

```bash
sudo docker compose exec web ls /tmp/
```

아래의 사진처럼 touch /tmp/success 가 성공을 한 것을 볼 수 있습니다.
![Image](https://github.com/user-attachments/assets/5c5da506-6565-4864-9705-884e057487de)

## 참고 자료
https://github.com/vulhub/vulhub/tree/master/superset/CVE-2023-37941  
https://nvd.nist.gov/vuln/detail/CVE-2023-37941  
https://en.wikipedia.org/wiki/Apache_Superset  
https://horizon3.ai/attack-research/disclosures/apache-superset-part-ii-rce-credential-harvesting-and-more/
